# CVErt Ops — Environment Variables
# Copy this file to .env and fill in your values.
# .env is gitignored and never committed.
#
# Notation:
#   (required)  — server refuses to start without this
#   (default)   — shown value is the built-in default; set only to override
#   (optional)  — feature is disabled if unset

# ─────────────────────────────────────────────────────────────────────────────
# Docker Compose — dev stack only (docker/compose.yml variable substitution)
# ─────────────────────────────────────────────────────────────────────────────

# (required for compose) Postgres superuser password
POSTGRES_PASSWORD=change_me_dev_only

# (default) Postgres database name and user
POSTGRES_DB=cvert_ops
POSTGRES_USER=cvert_ops

# (default) Host port mappings
POSTGRES_PORT=5432
APP_PORT=8080
MAILPIT_SMTP_PORT=1025
MAILPIT_UI_PORT=8025

# (default) Caddy reverse proxy host — controls TLS behaviour (docker --profile app only).
# localhost → HTTP only on :80. No TLS, no ACME. Correct for local dev.
# A real domain (e.g. cvert.example.com) → Caddy auto-provisions TLS via Let's Encrypt.
# When using a real domain also set: EXTERNAL_URL=https://... and COOKIE_SECURE=true
CADDY_HOST=localhost
CADDY_HTTP_PORT=80
CADDY_HTTPS_PORT=443


# ─────────────────────────────────────────────────────────────────────────────
# Database
# ─────────────────────────────────────────────────────────────────────────────

# (required) PostgreSQL connection string.
# In Docker Compose the app service builds this from the POSTGRES_* vars above;
# set this directly when running the app outside of compose.
DATABASE_URL=postgresql://cvert_ops:change_me_dev_only@localhost:5432/cvert_ops?sslmode=disable

# (default) Maximum number of open DB connections in the pool.
# Scaling formula: DB_MAX_CONNS × number_of_app_instances < postgres_max_connections − 10
DB_MAX_CONNS=25

# (default) Close connections idle for longer than this duration (prevents NAT gateway drops).
# Format: Go duration string, e.g. 5m, 30s
DB_MAX_CONN_IDLE_TIME=5m

# (default) Per-query statement timeout in milliseconds. Workers that need
# longer (bulk import, retention cleanup) override this with SET LOCAL.
DB_STATEMENT_TIMEOUT_MS=14000

# (default) Use simple_protocol for PgBouncer transaction-pooling compatibility.
# Safe for direct Postgres connections too. Options: simple_protocol | extended_protocol
DB_QUERY_EXEC_MODE=simple_protocol


# ─────────────────────────────────────────────────────────────────────────────
# Server
# ─────────────────────────────────────────────────────────────────────────────

# (default) Address the HTTP server binds to
LISTEN_ADDR=:8080

# (default) Environment name; affects log format and other dev-vs-prod defaults
# Options: development | production
APP_ENV=development

# (required for OAuth) Publicly-accessible base URL of this instance.
# Used to construct OAuth redirect URIs — never derived from the Host header.
# Example: https://cvert.example.com
EXTERNAL_URL=http://localhost:8080

# (default) Graceful shutdown deadline in seconds
SHUTDOWN_TIMEOUT_SECONDS=60

# (default) Who can register a new account.
# Options: open | invite-only
REGISTRATION_MODE=open


# ─────────────────────────────────────────────────────────────────────────────
# Auth — JWT
# ─────────────────────────────────────────────────────────────────────────────

# (required) Symmetric signing secret for JWT access and refresh tokens.
# Minimum 32 cryptographically random bytes. Server exits at startup if missing
# or too short — auto-generation is intentionally NOT supported (would silently
# log out all users on every restart).
# Generate: openssl rand -base64 32
JWT_SECRET=

# (default) JWT signing algorithm
JWT_ALGORITHM=HS256


# ─────────────────────────────────────────────────────────────────────────────
# Auth — Cookies
# ─────────────────────────────────────────────────────────────────────────────

# (default) Set the Secure flag on auth cookies.
# MUST be false for http://localhost (browser silently drops Secure cookies over HTTP).
# MUST be true in production (set to true when TLS is in use).
COOKIE_SECURE=false


# ─────────────────────────────────────────────────────────────────────────────
# Auth — Password hashing (Argon2id)
# ─────────────────────────────────────────────────────────────────────────────

# (default) Max simultaneous argon2id hash operations.
# Each operation allocates ~19.5 MB. Excess requests receive 503 immediately
# (non-blocking) to prevent OOM under concurrent login attacks.
ARGON2_MAX_CONCURRENT=5


# ─────────────────────────────────────────────────────────────────────────────
# OAuth — GitHub
# ─────────────────────────────────────────────────────────────────────────────
# Create at: https://github.com/settings/developers → OAuth Apps
# Callback URL: ${EXTERNAL_URL}/api/v1/auth/oauth/github/callback

# (optional) GitHub OAuth credentials — GitHub login disabled if unset
GITHUB_CLIENT_ID=
GITHUB_CLIENT_SECRET=


# ─────────────────────────────────────────────────────────────────────────────
# OAuth — Google
# ─────────────────────────────────────────────────────────────────────────────
# Create at: https://console.cloud.google.com → APIs & Services → Credentials
# Callback URL: ${EXTERNAL_URL}/api/v1/auth/oauth/google/callback

# (optional) Google OAuth credentials — Google login disabled if unset
GOOGLE_CLIENT_ID=
GOOGLE_CLIENT_SECRET=


# ─────────────────────────────────────────────────────────────────────────────
# Email (SMTP)
# ─────────────────────────────────────────────────────────────────────────────

# In dev, point at Mailpit (started by docker compose up -d).
# Mailpit web UI: http://localhost:8025
SMTP_HOST=localhost
SMTP_PORT=1025
SMTP_FROM=cvert-ops@localhost
# SMTP_USERNAME=
# SMTP_PASSWORD=
# SMTP_TLS=false


# ─────────────────────────────────────────────────────────────────────────────
# AI — Google Gemini
# ─────────────────────────────────────────────────────────────────────────────
# Create at: https://aistudio.google.com/apikey

# (optional) Gemini API key — AI features (NL search, CVE summaries) disabled if unset
GEMINI_API_KEY=

# (default) Gemini model to use for structured query generation
GEMINI_MODEL=gemini-2.0-flash


# ─────────────────────────────────────────────────────────────────────────────
# Feed adapters
# ─────────────────────────────────────────────────────────────────────────────

# (optional) NVD API key — unauthenticated rate limit is 5 req/30s (slow);
# authenticated is 50 req/30s. Get one at: https://nvd.nist.gov/developers/request-an-api-key
NVD_API_KEY=


# ─────────────────────────────────────────────────────────────────────────────
# Notifications — delivery
# ─────────────────────────────────────────────────────────────────────────────

# (default) Max concurrent outbound deliveries per org (noisy-neighbour protection)
NOTIFY_MAX_CONCURRENT_PER_ORG=5

# (default) Debounce window in seconds: CVEs matching the same rule+channel within
# this window are batched into a single notification rather than N separate sends.
NOTIFY_DEBOUNCE_SECONDS=120

# (default) How long to accept the old signing secret after rotation (dual-secret window)
WEBHOOK_SECRET_GRACE_HOURS=24


# ─────────────────────────────────────────────────────────────────────────────
# Rate limiting
# ─────────────────────────────────────────────────────────────────────────────

# (default) Comma-separated CIDR ranges of trusted reverse proxies.
# When set, the rate limiter reads the real client IP from X-Forwarded-For
# (rightmost non-trusted entry) instead of r.RemoteAddr.
# Leave empty for direct connections (no reverse proxy).
# Example: 10.0.0.0/8,172.16.0.0/12
TRUSTED_PROXIES=

# (default) TTL for in-memory rate limiter entries; must be > token refill window.
# Format: Go duration string
RATE_LIMIT_EVICT_TTL=15m


# ─────────────────────────────────────────────────────────────────────────────
# Data retention cleanup
# ─────────────────────────────────────────────────────────────────────────────

# (default) Enable the daily retention cleanup job
RETENTION_CLEANUP_ENABLED=true

# (default) Number of rows deleted per batch in the cleanup job
RETENTION_CLEANUP_BATCH_SIZE=10000


# ─────────────────────────────────────────────────────────────────────────────
# Logging
# ─────────────────────────────────────────────────────────────────────────────

# (default) Log verbosity. Options: debug | info | warn | error
LOG_LEVEL=info

# (default) Log output format. Options: text (human-readable) | json (structured)
LOG_FORMAT=json


# ─────────────────────────────────────────────────────────────────────────────
# Go runtime tuning (advanced)
# ─────────────────────────────────────────────────────────────────────────────

# Memory limit for the Go runtime GC target.
# In containers, automemlimit sets this automatically from cgroup limits.
# Only set manually if you need to override automemlimit's value.
# Example: 400MiB
# GOMEMLIMIT=

# GC target percentage. Default is 100 (GC when heap doubles).
# Lower values (e.g. 50) trigger GC more often at the cost of CPU.
# GOGC=100
