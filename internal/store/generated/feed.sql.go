// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: feed.sql

package store

import (
	"context"
	"database/sql"

	"github.com/google/uuid"
	"github.com/sqlc-dev/pqtype"
)

const getFeedSyncState = `-- name: GetFeedSyncState :one
SELECT feed_name, cursor_json, last_success_at, last_attempt_at, consecutive_failures, last_error, backoff_until FROM feed_sync_state WHERE feed_name = $1
`

func (q *Queries) GetFeedSyncState(ctx context.Context, feedName string) (FeedSyncState, error) {
	row := q.db.QueryRowContext(ctx, getFeedSyncState, feedName)
	var i FeedSyncState
	err := row.Scan(
		&i.FeedName,
		&i.CursorJson,
		&i.LastSuccessAt,
		&i.LastAttemptAt,
		&i.ConsecutiveFailures,
		&i.LastError,
		&i.BackoffUntil,
	)
	return i, err
}

const insertFeedFetchLog = `-- name: InsertFeedFetchLog :one
INSERT INTO feed_fetch_log (
    feed_name, status, items_fetched, items_upserted,
    cursor_before, cursor_after, error_summary, ended_at
)
VALUES ($1, $2, $3, $4, $5, $6, $7, now())
RETURNING id
`

type InsertFeedFetchLogParams struct {
	FeedName      string
	Status        string
	ItemsFetched  int32
	ItemsUpserted int32
	CursorBefore  pqtype.NullRawMessage
	CursorAfter   pqtype.NullRawMessage
	ErrorSummary  sql.NullString
}

func (q *Queries) InsertFeedFetchLog(ctx context.Context, arg InsertFeedFetchLogParams) (uuid.UUID, error) {
	row := q.db.QueryRowContext(ctx, insertFeedFetchLog,
		arg.FeedName,
		arg.Status,
		arg.ItemsFetched,
		arg.ItemsUpserted,
		arg.CursorBefore,
		arg.CursorAfter,
		arg.ErrorSummary,
	)
	var id uuid.UUID
	err := row.Scan(&id)
	return id, err
}

const upsertFeedSyncState = `-- name: UpsertFeedSyncState :exec
INSERT INTO feed_sync_state (
    feed_name, cursor_json, last_success_at, last_attempt_at,
    consecutive_failures, last_error, backoff_until
)
VALUES ($1, $2, $3, $4, $5, $6, $7)
ON CONFLICT (feed_name) DO UPDATE
    SET cursor_json          = EXCLUDED.cursor_json,
        last_success_at      = EXCLUDED.last_success_at,
        last_attempt_at      = EXCLUDED.last_attempt_at,
        consecutive_failures = EXCLUDED.consecutive_failures,
        last_error           = EXCLUDED.last_error,
        backoff_until        = EXCLUDED.backoff_until
`

type UpsertFeedSyncStateParams struct {
	FeedName            string
	CursorJson          pqtype.NullRawMessage
	LastSuccessAt       sql.NullTime
	LastAttemptAt       sql.NullTime
	ConsecutiveFailures int32
	LastError           sql.NullString
	BackoffUntil        sql.NullTime
}

func (q *Queries) UpsertFeedSyncState(ctx context.Context, arg UpsertFeedSyncStateParams) error {
	_, err := q.db.ExecContext(ctx, upsertFeedSyncState,
		arg.FeedName,
		arg.CursorJson,
		arg.LastSuccessAt,
		arg.LastAttemptAt,
		arg.ConsecutiveFailures,
		arg.LastError,
		arg.BackoffUntil,
	)
	return err
}
