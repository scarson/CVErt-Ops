// Code generated by sqlc. DO NOT EDIT.
// versions:
//   sqlc v1.30.0
// source: notification_channels.sql

package store

import (
	"context"
	"database/sql"
	"encoding/json"
	"time"

	"github.com/google/uuid"
)

const channelHasActiveBoundRules = `-- name: ChannelHasActiveBoundRules :one
SELECT EXISTS(
    SELECT 1
    FROM alert_rule_channels arc
    JOIN alert_rules ar ON ar.id = arc.rule_id
    WHERE arc.channel_id = $1
      AND ar.org_id = $2
      AND ar.status NOT IN ('draft', 'disabled', 'deleted')
      AND ar.deleted_at IS NULL
) AS has_active_rules
`

type ChannelHasActiveBoundRulesParams struct {
	ChannelID uuid.UUID
	OrgID     uuid.UUID
}

// Pre-flight check before soft-delete. Active = not draft/disabled/deleted.
func (q *Queries) ChannelHasActiveBoundRules(ctx context.Context, arg ChannelHasActiveBoundRulesParams) (bool, error) {
	row := q.db.QueryRowContext(ctx, channelHasActiveBoundRules, arg.ChannelID, arg.OrgID)
	var has_active_rules bool
	err := row.Scan(&has_active_rules)
	return has_active_rules, err
}

const clearSecondarySecret = `-- name: ClearSecondarySecret :exec
UPDATE notification_channels
SET signing_secret_secondary = NULL, updated_at = now()
WHERE id = $1 AND org_id = $2 AND deleted_at IS NULL
`

type ClearSecondarySecretParams struct {
	ID    uuid.UUID
	OrgID uuid.UUID
}

func (q *Queries) ClearSecondarySecret(ctx context.Context, arg ClearSecondarySecretParams) error {
	_, err := q.db.ExecContext(ctx, clearSecondarySecret, arg.ID, arg.OrgID)
	return err
}

const createNotificationChannel = `-- name: CreateNotificationChannel :one

INSERT INTO notification_channels (org_id, name, type, config, signing_secret)
VALUES ($1, $2, $3, $4, $5)
RETURNING id, org_id, name, type, config, deleted_at, created_at, updated_at
`

type CreateNotificationChannelParams struct {
	OrgID         uuid.UUID
	Name          string
	Type          string
	Config        json.RawMessage
	SigningSecret string
}

type CreateNotificationChannelRow struct {
	ID        uuid.UUID
	OrgID     uuid.UUID
	Name      string
	Type      string
	Config    json.RawMessage
	DeletedAt sql.NullTime
	CreatedAt time.Time
	UpdatedAt time.Time
}

// ABOUTME: sqlc queries for notification channel CRUD.
// ABOUTME: Secrets (signing_secret) are excluded from most queries; use GetChannelForDelivery.
func (q *Queries) CreateNotificationChannel(ctx context.Context, arg CreateNotificationChannelParams) (CreateNotificationChannelRow, error) {
	row := q.db.QueryRowContext(ctx, createNotificationChannel,
		arg.OrgID,
		arg.Name,
		arg.Type,
		arg.Config,
		arg.SigningSecret,
	)
	var i CreateNotificationChannelRow
	err := row.Scan(
		&i.ID,
		&i.OrgID,
		&i.Name,
		&i.Type,
		&i.Config,
		&i.DeletedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getNotificationChannel = `-- name: GetNotificationChannel :one
SELECT id, org_id, name, type, config, deleted_at, created_at, updated_at
FROM notification_channels
WHERE id = $1 AND org_id = $2 AND deleted_at IS NULL
LIMIT 1
`

type GetNotificationChannelParams struct {
	ID    uuid.UUID
	OrgID uuid.UUID
}

type GetNotificationChannelRow struct {
	ID        uuid.UUID
	OrgID     uuid.UUID
	Name      string
	Type      string
	Config    json.RawMessage
	DeletedAt sql.NullTime
	CreatedAt time.Time
	UpdatedAt time.Time
}

func (q *Queries) GetNotificationChannel(ctx context.Context, arg GetNotificationChannelParams) (GetNotificationChannelRow, error) {
	row := q.db.QueryRowContext(ctx, getNotificationChannel, arg.ID, arg.OrgID)
	var i GetNotificationChannelRow
	err := row.Scan(
		&i.ID,
		&i.OrgID,
		&i.Name,
		&i.Type,
		&i.Config,
		&i.DeletedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}

const getNotificationChannelForDelivery = `-- name: GetNotificationChannelForDelivery :one
SELECT id, org_id, type, config, signing_secret, signing_secret_secondary
FROM notification_channels
WHERE id = $1 AND deleted_at IS NULL
LIMIT 1
`

type GetNotificationChannelForDeliveryRow struct {
	ID                     uuid.UUID
	OrgID                  uuid.UUID
	Type                   string
	Config                 json.RawMessage
	SigningSecret          string
	SigningSecretSecondary sql.NullString
}

// Includes signing secrets — used by delivery worker only; never exposed via API.
func (q *Queries) GetNotificationChannelForDelivery(ctx context.Context, id uuid.UUID) (GetNotificationChannelForDeliveryRow, error) {
	row := q.db.QueryRowContext(ctx, getNotificationChannelForDelivery, id)
	var i GetNotificationChannelForDeliveryRow
	err := row.Scan(
		&i.ID,
		&i.OrgID,
		&i.Type,
		&i.Config,
		&i.SigningSecret,
		&i.SigningSecretSecondary,
	)
	return i, err
}

const listNotificationChannels = `-- name: ListNotificationChannels :many
SELECT id, org_id, name, type, config, deleted_at, created_at, updated_at
FROM notification_channels
WHERE org_id = $1 AND deleted_at IS NULL
ORDER BY created_at DESC, id DESC
`

type ListNotificationChannelsRow struct {
	ID        uuid.UUID
	OrgID     uuid.UUID
	Name      string
	Type      string
	Config    json.RawMessage
	DeletedAt sql.NullTime
	CreatedAt time.Time
	UpdatedAt time.Time
}

func (q *Queries) ListNotificationChannels(ctx context.Context, orgID uuid.UUID) ([]ListNotificationChannelsRow, error) {
	rows, err := q.db.QueryContext(ctx, listNotificationChannels, orgID)
	if err != nil {
		return nil, err
	}
	defer rows.Close()
	var items []ListNotificationChannelsRow
	for rows.Next() {
		var i ListNotificationChannelsRow
		if err := rows.Scan(
			&i.ID,
			&i.OrgID,
			&i.Name,
			&i.Type,
			&i.Config,
			&i.DeletedAt,
			&i.CreatedAt,
			&i.UpdatedAt,
		); err != nil {
			return nil, err
		}
		items = append(items, i)
	}
	if err := rows.Close(); err != nil {
		return nil, err
	}
	if err := rows.Err(); err != nil {
		return nil, err
	}
	return items, nil
}

const rotateSigningSecret = `-- name: RotateSigningSecret :one
UPDATE notification_channels
SET signing_secret_secondary = signing_secret,
    signing_secret           = $3,
    updated_at               = now()
WHERE id = $1 AND org_id = $2 AND deleted_at IS NULL
RETURNING signing_secret
`

type RotateSigningSecretParams struct {
	ID            uuid.UUID
	OrgID         uuid.UUID
	SigningSecret string
}

// Atomically moves primary → secondary, sets new primary.
func (q *Queries) RotateSigningSecret(ctx context.Context, arg RotateSigningSecretParams) (string, error) {
	row := q.db.QueryRowContext(ctx, rotateSigningSecret, arg.ID, arg.OrgID, arg.SigningSecret)
	var signing_secret string
	err := row.Scan(&signing_secret)
	return signing_secret, err
}

const softDeleteNotificationChannel = `-- name: SoftDeleteNotificationChannel :exec
UPDATE notification_channels
SET deleted_at = now(), updated_at = now()
WHERE id = $1 AND org_id = $2 AND deleted_at IS NULL
`

type SoftDeleteNotificationChannelParams struct {
	ID    uuid.UUID
	OrgID uuid.UUID
}

func (q *Queries) SoftDeleteNotificationChannel(ctx context.Context, arg SoftDeleteNotificationChannelParams) error {
	_, err := q.db.ExecContext(ctx, softDeleteNotificationChannel, arg.ID, arg.OrgID)
	return err
}

const updateNotificationChannel = `-- name: UpdateNotificationChannel :one
UPDATE notification_channels
SET name       = $3,
    config     = $4,
    updated_at = now()
WHERE id = $1 AND org_id = $2 AND deleted_at IS NULL
RETURNING id, org_id, name, type, config, deleted_at, created_at, updated_at
`

type UpdateNotificationChannelParams struct {
	ID     uuid.UUID
	OrgID  uuid.UUID
	Name   string
	Config json.RawMessage
}

type UpdateNotificationChannelRow struct {
	ID        uuid.UUID
	OrgID     uuid.UUID
	Name      string
	Type      string
	Config    json.RawMessage
	DeletedAt sql.NullTime
	CreatedAt time.Time
	UpdatedAt time.Time
}

// Full replacement of mutable fields. Handler reads existing record and applies
// pointer-typed patch fields before calling this.
func (q *Queries) UpdateNotificationChannel(ctx context.Context, arg UpdateNotificationChannelParams) (UpdateNotificationChannelRow, error) {
	row := q.db.QueryRowContext(ctx, updateNotificationChannel,
		arg.ID,
		arg.OrgID,
		arg.Name,
		arg.Config,
	)
	var i UpdateNotificationChannelRow
	err := row.Scan(
		&i.ID,
		&i.OrgID,
		&i.Name,
		&i.Type,
		&i.Config,
		&i.DeletedAt,
		&i.CreatedAt,
		&i.UpdatedAt,
	)
	return i, err
}
